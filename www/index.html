<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>أبو الزهراء - الاتصال الآمن</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase & Twilio SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://media.twiliocdn.com/sdk/js/client/v1/twilio.min.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AX77yPd3nZvqVsQtTKLAUXVLk9ieO71wvjDk2m3alQcG7ft_J6EOGlacBjrcOvAVghFiYWwPee2S3sfg&currency=USD" async></script>

    <style>
        :root {
            --primary-azure: #0078D7;
            --primary-dark: #005A9E;
            --accent-blue: #00B0F0;
            --white: #ffffff;
            --bg: #f0f2f5;
            --text: #333;
            --green: #107C10;
            --red: #A80000;
            --gray: #999;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        #app { width: 100%; max-width: 400px; height: 100vh; max-height: 850px; background: #fff; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.2); }

        /* --- مصادقة --- */
        .auth-container {
            position: absolute; inset: 0; background: var(--primary-azure); color: white; z-index: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; transition: opacity 0.3s;
        }
        .auth-logo { font-size: 4rem; margin-bottom: 10px; color: var(--white); text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .auth-title { font-size: 2rem; font-weight: 700; margin-bottom: 40px; letter-spacing: 1px; }
        
        .auth-btn-group { display: flex; flex-direction: column; gap: 15px; width: 80%; }
        .btn-auth-lg { padding: 15px; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); transition: 0.2s; }
        .btn-white { background: white; color: var(--primary-azure); }
        .btn-blue { background: transparent; color: white; border: 1px solid white; }
        
        .auth-form { background: white; width: 90%; max-width: 350px; padding: 30px; border-radius: 20px; color: var(--text); box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideUp 0.3s ease-out; }
        .form-input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; transition: 0.3s; background: #fafafa; }
        .form-input:focus { border-color: var(--primary-azure); background: #fff; }
        .btn-back { margin-top: 15px; color: #888; cursor: pointer; font-size: 0.9rem; }

        /* --- الواجهة الرئيسية --- */
        #main-interface { flex: 1; display: flex; flex-direction: column; height: 100%; opacity: 0; visibility: hidden; }
        #main-interface.visible { opacity: 1; visibility: visible; }

        header { background: var(--primary-azure); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .header-left { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .status-dot { width: 10px; height: 10px; background: #00E676; border-radius: 50%; box-shadow: 0 0 8px #00E676; }
        .header-balance { background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; transition: 0.2s; }
        .header-balance:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        /* --- الصفحات --- */
        .page { flex: 1; overflow-y: auto; display: none; padding-bottom: 75px; background: var(--bg); position: relative; -webkit-overflow-scrolling: touch; }
        .page.active { display: block; }

        /* --- لوحة الاتصال --- */
        .dial-display { background: white; padding: 30px 20px; text-align: center; border-bottom: 1px solid #eee; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        #dial-number { font-size: 2.5rem; font-weight: 700; min-height: 50px; letter-spacing: 2px; color: var(--primary-azure); }
        
        #alias-input-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background: #f0f8ff; }
        #alias-input-container.open { max-height: 60px; border-top: 1px solid #e3f2fd; margin-top: 15px; }
        #alias-input { width: 90%; padding: 8px 12px; border: 1px solid var(--primary-azure); border-radius: 20px; text-align: center; color: var(--primary-azure); background: white; outline: none; font-size: 0.9rem; }

        .dial-options { display: flex; justify-content: center; gap: 25px; margin-top: 15px; }
        .toggle-label { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #555; cursor: pointer; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .2s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-azure); }
        input:checked + .slider:before { transform: translateX(18px); }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 30px; }
        .key { background: white; width: 70px; height: 70px; border-radius: 50%; margin: 0 auto; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.8rem; color: var(--primary-azure); font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; border: 1px solid rgba(0,120,215,0.05); touch-action: manipulation; transition: 0.1s; }
        .key:active { background: #E3F2FD; transform: scale(0.92); }
        .key sub { font-size: 0.7rem; color: var(--primary-azure); opacity: 0.6; margin-top: -4px; font-weight: 400; pointer-events: none; }
        
        .dial-actions { display: flex; justify-content: center; gap: 25px; padding-bottom: 20px; }
        .circle-btn { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; cursor: pointer; background: white; color: var(--text); touch-action: manipulation; transition: 0.1s; }
        .circle-btn:active { transform: scale(0.9); }
        .btn-call { background: var(--primary-azure); color: white; width: 75px; height: 75px; font-size: 2rem; box-shadow: 0 6px 20px rgba(0,120,215,0.3); }
        .btn-del { color: #d32f2f; }
        .btn-add { color: var(--primary-azure); }

        /* --- القوائم والرسائل --- */
        .tabs { display: flex; background: white; padding: 0 10px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; text-align: center; padding: 14px; color: #666; font-size: 0.9rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; }
        .tab.active { color: var(--primary-azure); border-bottom-color: var(--primary-azure); }
        
        .list-item { background: white; padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .list-item:active { background: #f8f9fa; }
        .item-info { display: flex; align-items: center; gap: 15px; flex: 1; }
        .avatar { width: 48px; height: 48px; background: #E1F5FE; color: var(--primary-azure); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .item-details h4 { font-size: 1rem; color: #333; margin-bottom: 2px; }
        .item-details p { font-size: 0.85rem; color: #888; }

        .tab-fab { position: absolute; bottom: 85px; left: 20px; width: 55px; height: 55px; background: var(--primary-azure); color: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 6; font-size: 1.3rem; }

        /* --- قسم المزيد --- */
        .more-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; }
        .more-card { background: white; padding: 25px 10px; border-radius: 18px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .more-card:active { transform: scale(0.95); border-color: #eee; }
        .more-icon { width: 50px; height: 50px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin: 0 auto 10px; color: white; }

        /* --- النافبار السفلي --- */
        nav { position: absolute; bottom: 0; width: 100%; height: 70px; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 50; }
        .nav-item { color: #999; text-align: center; font-size: 0.7rem; cursor: pointer; width: 20%; touch-action: manipulation; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary-azure); }

        /* --- الصفحات الفرعية --- */
        .sub-page { position: absolute; inset: 0; background: white; z-index: 200; display: none; flex-direction: column; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .sub-header { background: var(--primary-azure); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sub-content { flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; }
        
        .info-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-block { width: 100%; padding: 14px; background: var(--primary-azure); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }

        /* --- شاشة المكالمة --- */
        #call-screen { position: absolute; inset: 0; background: linear-gradient(180deg, #004e92, #000428); color: white; z-index: 300; display: none; flex-direction: column; justify-content: space-between; padding: 60px 20px; }
        .caller-info { text-align: center; }
        .caller-avatar { width: 120px; height: 120px; background: rgba(255,255,255,0.15); border-radius: 50%; margin: 0 auto 25px; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; border: 2px solid rgba(255,255,255,0.2); }
        .call-status { font-size: 1.2rem; opacity: 0.9; margin-top: 10px; }
        .call-timer { font-size: 3rem; font-weight: 300; margin-top: 20px; font-family: monospace; display: none; }
        
        .call-controls { display: flex; gap: 30px; justify-content: center; margin-bottom: 40px; }
        .ctrl-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.15); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; transition: 0.2s; }
        .ctrl-btn.active { background: white; color: var(--primary-azure); }
        
        .btn-end-wide { width: 200px; padding: 15px; background: var(--red); color: white; border: none; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(168, 0, 0, 0.3); margin: 0 auto; }
        .btn-end-wide:active { transform: scale(0.95); }

        /* --- DTMF --- */
        #dtmf-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); padding: 20px; display: none; grid-template-columns: repeat(3, 1fr); gap: 15px; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 350; }

        /* --- Utility --- */
        #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.95rem; opacity: 0; transition: 0.3s; z-index: 600; pointer-events: none; text-align: center; }
        #toast.show { opacity: 1; }
        
        /* --- Chat Interface --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 10px; }
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; font-size: 0.95rem; line-height: 1.4; }
        .msg-received { background: #e0e0e0; color: #333; align-self: flex-start; border-bottom-right-radius: 2px; }
        .msg-sent { background: var(--primary-azure); color: white; align-self: flex-end; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 10px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. شاشات المصادقة -->
    <div id="auth-start" class="auth-container">
        <i class="fas fa-phone-volume auth-logo"></i>
        <div class="auth-title">أبو الزهراء</div>
        <div class="auth-btn-group">
            <button class="btn-auth-lg btn-white" onclick="showAuth('welcome')">دخول / تسجيل</button>
        </div>
    </div>

    <div id="auth-welcome" class="auth-container" style="display:none;">
        <div class="auth-logo" style="font-size:3rem; margin-bottom:20px;"><i class="fas fa-user-circle"></i></div>
        <div class="auth-btn-group">
            <button class="btn-auth-lg btn-white" onclick="showAuth('login')">تسجيل الدخول</button>
            <button class="btn-auth-lg btn-blue" onclick="showAuth('register')">حساب جديد</button>
        </div>
    </div>

    <div id="auth-login" class="auth-container" style="display:none; background: white; color: var(--text);">
        <div class="auth-form">
            <h2 style="color:var(--primary-azure); margin-bottom:20px;">مرحباً بعودتك</h2>
            <input type="email" id="login-email" class="form-input" placeholder="البريد الإلكتروني">
            <input type="password" id="login-pass" class="form-input" placeholder="كلمة المرور">
            <button class="btn-block" onclick="handleLogin()">دخول</button>
            <div class="btn-back" onclick="showAuth('welcome')">الرجوع</div>
        </div>
    </div>

    <div id="auth-register" class="auth-container" style="display:none; background: white; color: var(--text);">
        <div class="auth-form">
            <h2 style="color:var(--primary-azure); margin-bottom:20px;">حساب جديد</h2>
            <input type="email" id="reg-email" class="form-input" placeholder="البريد الإلكتروني">
            <input type="password" id="reg-pass" class="form-input" placeholder="كلمة المرور">
            <input type="password" id="reg-pass-conf" class="form-input" placeholder="تأكيد كلمة المرور">
            <button class="btn-block" onclick="handleRegister()">إنشاء الحساب</button>
            <div class="btn-back" onclick="showAuth('welcome')">الرجوع</div>
        </div>
    </div>

    <!-- 2. الواجهة الرئيسية -->
    <div id="main-interface">
        <header>
            <div class="header-left">
                <div class="status-dot"></div>
                <span style="font-weight:bold; font-size:1.1rem;">أبو الزهراء</span>
            </div>
            <!-- تم إصلاح onclick لفتح قسم الشحن -->
            <div class="header-balance" onclick="openSubPage('page-topup')">
                <i class="fas fa-wallet"></i> $<span id="header-balance">0.63</span>
            </div>
        </header>

        <!-- صفحة الاتصال -->
        <div id="page-dialer" class="page active">
            <div class="dial-display">
                <div id="dial-number"></div>
                <div id="alias-input-container">
                    <input type="text" id="alias-input" placeholder="اسم المتصل البديل (عنوان SIP)">
                </div>
                <div class="dial-options">
                    <label class="toggle-label">
                        <div class="switch">
                            <input type="checkbox" id="chk-record">
                            <span class="slider"></span>
                        </div>
                        تسجيل
                    </label>
                    <label class="toggle-label">
                        <div class="switch">
                            <input type="checkbox" id="chk-hide-id" onchange="toggleAlias()">
                            <span class="slider"></span>
                        </div>
                        إخفاء الرقم
                    </label>
                </div>
            </div>
            <div class="keypad">
                <div class="key" onclick="dial('1')">1</div><div class="key" onclick="dial('2')">2<sub>ABC</sub></div><div class="key" onclick="dial('3')">3<sub>DEF</sub></div>
                <div class="key" onclick="dial('4')">4<sub>GHI</sub></div><div class="key" onclick="dial('5')">5<sub>JKL</sub></div><div class="key" onclick="dial('6')">6<sub>MNO</sub></div>
                <div class="key" onclick="dial('7')">7<sub>PQRS</sub></div><div class="key" onclick="dial('8')">8<sub>TUV</sub></div><div class="key" onclick="dial('9')">9<sub>WXYZ</sub></div>
                <div class="key" onclick="dial('*')">*</div>
                <!-- زر 0 الخاص بالضغط المطول -->
                <div class="key" id="key-0">0<sub>+</sub></div>
                <div class="key" onclick="dial('#')">#</div>
            </div>
            <div class="dial-actions">
                <button class="circle-btn btn-add" onclick="openAddContact()"><i class="fas fa-user-plus"></i></button>
                <button class="circle-btn btn-call" onclick="initiateRealCall()"><i class="fas fa-phone"></i></button>
                <button class="circle-btn btn-del" onclick="deleteDigit()"><i class="fas fa-backspace"></i></button>
            </div>
        </div>

        <!-- صفحة الأسماء (Contacts) -->
        <div id="page-contacts" class="page">
            <div class="tabs">
                <div class="tab active" onclick="switchContactTab('all', this)">الكل</div>
                <div class="tab" onclick="switchContactTab('fav', this)">المفضلة</div>
            </div>
            <div id="contacts-list" style="padding-top:10px;"></div>
            <div class="tab-fab" onclick="openAddContact()"><i class="fas fa-plus"></i></div>
        </div>

        <!-- صفحة السجلات (Logs) -->
        <div id="page-logs" class="page">
            <div class="tabs">
                <div class="tab active" onclick="switchLogTab('all', this)">جميع المكالمات</div>
                <div class="tab" onclick="switchLogTab('recordings', this)">التسجيلات</div>
            </div>
            <div id="logs-list" style="padding-top:10px;"></div>
        </div>

        <!-- صفحة الرسائل (Messages) - تم إصلاح التبويبات -->
        <div id="page-messages" class="page">
            <div class="tabs">
                <div class="tab active" onclick="switchMsgTab('notifications', this)">الإشعارات</div>
                <div class="tab" onclick="switchMsgTab('sms', this)">SMS</div>
            </div>
            
            <!-- محتوى الإشعارات -->
            <div id="msg-notifications" style="padding-top:10px;">
                <p style="text-align:center; color:#999; padding:20px;">لا توجد إشعارات جديدة</p>
            </div>
            
            <!-- محتوى SMS -->
            <div id="msg-sms" style="padding-top:10px; display:none;">
                <div id="messages-list"></div>
            </div>
            
            <!-- زر إنشاء رسالة تم إصلاح onclick -->
            <div class="tab-fab" onclick="openNewMessageUI()"><i class="fas fa-pen"></i></div>
        </div>

        <!-- صفحة المزيد (More) - الأزرار الستة تم تفعيل onclick -->
        <div id="page-more" class="page">
            <div class="more-grid">
                <div class="more-card" onclick="openSubPage('page-topup')">
                    <div class="more-icon" style="background:#FF9800;"><i class="fas fa-credit-card"></i></div>
                    <div class="more-label">إعادة الشحن</div>
                </div>
                <div class="more-card" onclick="openSubPage('page-rates')">
                    <div class="more-icon" style="background:#9C27B0;"><i class="fas fa-search-dollar"></i></div>
                    <div class="more-label">التعرفة</div>
                </div>
                <div class="more-card" onclick="openSubPage('page-reports')">
                    <div class="more-icon" style="background:#607D8B;"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="more-label">التقارير</div>
                </div>
                <div class="more-card" onclick="openSubPage('page-account')">
                    <div class="more-icon" style="background:#4CAF50;"><i class="fas fa-id-card"></i></div>
                    <div class="more-label">حسابي</div>
                </div>
                <div class="more-card" onclick="openSubPage('page-transfer')">
                    <div class="more-icon" style="background:#F44336;"><i class="fas fa-exchange-alt"></i></div>
                    <div class="more-label">تحويل الرصيد</div>
                </div>
                <div class="more-card" onclick="window.open('https://wa.me/967784702352', '_blank')">
                    <div class="more-icon" style="background:#25D366;"><i class="fab fa-whatsapp"></i></div>
                    <div class="more-label">الدعم</div>
                </div>
            </div>
            <div style="text-align:center; padding:20px;">
                <button class="btn-auth" style="background:#eee; color:#666; padding:10px 25px;" onclick="handleLogout()">تسجيل الخروج</button>
            </div>
        </div>

        <!-- النافبار -->
        <nav>
            <div class="nav-item active" onclick="nav('page-dialer', this)"><i class="fas fa-th"></i>الشبكة</div>
            <div class="nav-item" onclick="nav('page-logs', this)"><i class="fas fa-clock"></i>السجل</div>
            <div class="nav-item" onclick="nav('page-contacts', this)"><i class="fas fa-user-friends"></i>الأسماء</div>
            <div class="nav-item" onclick="nav('page-messages', this)"><i class="fas fa-comment-alt"></i>الرسائل</div>
            <div class="nav-item" onclick="nav('page-more', this)"><i class="fas fa-bars"></i>المزيد</div>
        </nav>
    </div>

    <!-- --- الصفحات الفرعية والمودالز --- -->
    <div id="page-topup" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('page-topup')"></i> <span>شحن الرصيد</span></div>
        <div class="sub-content">
            <h3 style="text-align:center; margin-bottom:20px; color:#555;">اختر الباقة</h3>
            <div class="more-grid">
                <div class="more-card" onclick="selectPrice(0.99, this)"><div style="font-weight:bold; font-size:1.2rem;">$0.99</div></div>
                <div class="more-card" onclick="selectPrice(4.99, this)"><div style="font-weight:bold; font-size:1.2rem;">$4.99</div></div>
                <div class="more-card" onclick="selectPrice(9.99, this)"><div style="font-weight:bold; font-size:1.2rem;">$9.99</div></div>
                <div class="more-card" onclick="selectPrice(24.99, this)"><div style="font-weight:bold; font-size:1.2rem;">$24.99</div></div>
                <div class="more-card" onclick="selectPrice(49.99, this)"><div style="font-weight:bold; font-size:1.2rem;">$49.99</div></div>
                <div class="more-card" style="border: 1px dashed var(--primary-azure);" onclick="showToast('رمز المكافأة: BONUS2023');"><div style="font-weight:bold; color:var(--primary-azure);">مكافأة</div><div style="font-size:0.8rem;">$10</div></div>
            </div>
            <div id="paypal-container" style="min-height:50px; margin-top:20px;"></div>
            <div id="demo-pay" style="display:none; text-align:center; margin-top:20px;">
                <button class="btn-block" style="background:#FF9800;" onclick="simulatePay()">محاكاة الدفع</button>
            </div>
        </div>
    </div>

    <div id="page-rates" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('page-rates')"></i> <span>استعلام التعرفة</span></div>
        <div class="sub-content">
            <div class="info-card">
                <label style="display:block; margin-bottom:10px; font-weight:bold;">رقم الهاتف</label>
                <input type="text" id="rate-phone" class="form-input" placeholder="مثال: +967 777...">
            </div>
            <button class="btn-block" onclick="checkRate()">استعلام السعر</button>
            <div id="rate-result" style="margin-top:20px; padding:15px; background:#E3F2FD; border-radius:10px; display:none; text-align:center;">
                <h3 style="color:var(--primary-azure);">$0.05</h3>
                <p style="font-size:0.9rem; color:#666;">تكلفة الدقيقة الواحدة</p>
            </div>
        </div>
    </div>

    <div id="page-reports" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('page-reports')"></i> <span>سجل المعاملات</span></div>
        <div class="sub-content" id="reports-list"></div>
    </div>

    <div id="page-account" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('page-account')"></i> <span>حسابي</span></div>
        <div class="sub-content" style="text-align:center; padding-top:30px;">
            <div style="width:100px; height:100px; background:#E1F5FE; border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; font-size:2.5rem; color:var(--primary-azure);"><i class="fas fa-user-shield"></i></div>
            <h2 style="margin-bottom:20px;">أبو الزهراء VIP</h2>
            <div class="info-card" style="text-align:right; background:#fff;">
                <p style="margin-bottom:10px; color:#666;">رقم الحساب (UID)</p>
                <p id="account-uid-display" style="font-family:monospace; background:#f0f0f0; padding:10px; border-radius:5px; user-select:text;">...</p>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <p style="margin-bottom:5px; color:#666;">نسخة التطبيق</p>
                <h3 style="color:var(--primary-azure);">3.9.60</h3>
            </div>
        </div>
    </div>

    <div id="page-transfer" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('page-transfer')"></i> <span>تحويل رصيد</span></div>
        <div class="sub-content">
            <div class="info-card">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">رقم حساب المستلم (UID)</label>
                <input type="text" id="transfer-to" class="form-input" placeholder="أدخل UID المستلم">
            </div>
            <div class="info-card">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">المبلغ ($)</label>
                <input type="number" id="transfer-amount" class="form-input" placeholder="0.00">
            </div>
            <button class="btn-block" style="background:#9C27B0;" onclick="processTransfer()">تأكيد التحويل</button>
        </div>
    </div>

    <!-- صفحة الدردشة (Chat Interface) -->
    <div id="page-chat" class="sub-page">
        <div class="sub-header">
            <i class="fas fa-arrow-right" onclick="closeSubPage('page-chat')"></i> 
            <span id="chat-contact-name">دردشة</span>
        </div>
        <div class="sub-content" style="display:flex; flex-direction:column; padding:0;">
            <div id="chat-messages" class="chat-area"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="form-input" placeholder="اكتب رسالة...">
                <button class="circle-btn" style="background:var(--primary-azure); color:white;" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- مودال إضافة جهة اتصال -->
    <div id="modal-add-contact" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('modal-add-contact')"></i> <span>إضافة جهة اتصال</span></div>
        <div class="sub-content">
            <input type="text" id="new-contact-name" class="form-input" placeholder="الاسم">
            <input type="text" id="new-contact-number" class="form-input" placeholder="رقم الهاتف">
            <button class="btn-block" onclick="saveNewContact()">حفظ</button>
        </div>
    </div>

    <!-- مودال رسالة جديدة -->
    <div id="modal-new-msg" class="sub-page">
        <div class="sub-header"><i class="fas fa-arrow-right" onclick="closeSubPage('modal-new-msg')"></i> <span>رسالة جديدة</span></div>
        <div class="sub-content">
            <input type="text" id="new-msg-to" class="form-input" placeholder="إلى (رقم)">
            <textarea id="new-msg-body" class="form-input" rows="3" placeholder="الرسالة"></textarea>
            <button class="btn-block" onclick="sendNewMessage()">إرسال</button>
        </div>
    </div>

    <!-- شاشة المكالمة النشطة (Active Call) -->
    <div id="call-screen">
        <div class="caller-info">
            <div class="caller-avatar"><i class="fas fa-user"></i></div>
            <h2 id="call-name-display" style="margin-top:15px;">مجهول</h2>
            <p id="call-number-display" style="opacity:0.8; font-size:1.2rem;">...</p>
            <p id="call-status" class="call-status">جاري الاتصال...</p>
            <p id="call-timer" class="call-timer">00:00</p>
        </div>
        
        <div id="dtmf-overlay">
            <button class="key" onclick="sendDtmf('1')">1</button><button class="key" onclick="sendDtmf('2')">2</button><button class="key" onclick="sendDtmf('3')">3</button>
            <button class="key" onclick="sendDtmf('4')">4</button><button class="key" onclick="sendDtmf('5')">5</button><button class="key" onclick="sendDtmf('6')">6</button>
            <button class="key" onclick="sendDtmf('7')">7</button><button class="key" onclick="sendDtmf('8')">8</button><button class="key" onclick="sendDtmf('9')">9</button>
            <button class="key" onclick="sendDtmf('*')">*</button><button class="key" onclick="sendDtmf('0')">0</button><button class="key" onclick="sendDtmf('#')">#</button>
            <button class="btn-block" style="grid-column:span 3; background:#ddd; color:#333; font-size:0.9rem;" onclick="document.getElementById('dtmf-overlay').style.display='none'">إغلاق</button>
        </div>

        <div class="call-controls">
            <div class="ctrl-btn" onclick="toggleMute(this)"><i class="fas fa-microphone"></i></div>
            <div class="ctrl-btn" onclick="document.getElementById('dtmf-overlay').style.display='grid'"><i class="fas fa-th"></i></div>
            <div class="ctrl-btn" onclick="toggleSpeaker(this)"><i class="fas fa-volume-up"></i></div>
        </div>
        <div style="text-align:center; margin-bottom:30px;">
            <button class="btn-end-wide" onclick="hangupCall()">إنهاء المكالمة</button>
        </div>
    </div>

    <div id="toast"></div>
</div>

<script>
    // --- إعدادات Firebase (تم إضافة المفاتيح الصحيحة) ---
    const firebaseConfig = {
        apiKey: "AIzaSyD8hrO2kX1zXaA46PImzMGqOt4iTwhXKI0",
        authDomain: "call-now-24582.firebaseapp.com",
        projectId: "call-now-24582",
        storageBucket: "call-now-24582.firebasestorage.app",
        databaseURL: "https://call-now-24582-default-rtdb.firebaseio.com",
        messagingSenderId: "982107544824",
        appId: "1:982107544824:web:c5b6806042ba44ff896f0d",
        measurementId: "G-W27HMG1TKV"
    };

    // تهيئة Firebase
    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const auth = firebase.auth();
    const db = firebase.database();

    // --- متغيرات الحالة ---
    let device = null;
    let currentUser = null;
    let dialNumber = "";
    let balance = 0.63;
    let callTimer = null;
    let callSeconds = 0;
    let activeTransferPrice = 0;
    let currentChatNumber = null; // تتبع الدردشة المفتوحة

    // --- إدارة حالة المصادقة ---
    function showAuth(screen) {
        document.querySelectorAll('.auth-container').forEach(el => el.style.display = 'none');
        document.getElementById('auth-' + screen).style.display = 'flex';
    }

    function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        if(!email || !pass) return showToast('أكمل البيانات');
        
        auth.signInWithEmailAndPassword(email, pass)
            .then((user) => {
                enterApp();
            })
            .catch(err => {
                if(err.code === 'auth/user-not-found') handleRegister(email, pass);
                else showToast(err.message);
            });
    }

    function handleRegister(email, pass) {
        const e = email || document.getElementById('reg-email').value;
        const p = pass || document.getElementById('reg-pass').value;
        const p2 = document.getElementById('reg-pass-conf').value;
        
        if(p !== p2) return showToast("كلمات المرور غير متطابقة");
        
        auth.createUserWithEmailAndPassword(e, p)
            .then((user) => {
                db.ref('users/' + user.uid).set({ balance: 0.63, email: e });
                handleLogin();
            })
            .catch(err => showToast(err.message));
    }

    function handleLogout() { auth.signOut().then(() => location.reload()); }

    function enterApp() {
        document.querySelectorAll('.auth-container').forEach(el => el.style.display = 'none');
        document.getElementById('main-interface').classList.add('visible');
        loadUserData();
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            if(document.getElementById('account-uid-display'))
                document.getElementById('account-uid-display').innerText = user.uid;
            initTwilioDevice();
            loadUserData();
        } else {
            showAuth('start');
        }
    });

    // --- البيانات والمنطق ---
    function loadUserData() {
        db.ref('users/' + currentUser.uid + '/balance').on('value', snapshot => {
            balance = snapshot.val() || 0.63;
            document.getElementById('header-balance').innerText = balance.toFixed(2);
        });

        // الأسماء
        const contactsRef = db.ref('users/' + currentUser.uid + '/contacts');
        contactsRef.on('value', snapshot => {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            const data = snapshot.val();
            if(!data) { list.innerHTML = '<p style="text-align:center; color:#999; padding:30px;">لا توجد أسماء</p>'; return; }
            Object.keys(data).forEach(key => {
                const c = data[key];
                list.innerHTML += `
                    <div class="list-item" onclick="setDial('${c.number}')">
                        <div class="item-info">
                            <div class="avatar">${c.name.charAt(0)}</div>
                            <div class="item-details"><h4>${c.name}</h4><p>${c.number}</p></div>
                        </div>
                        <button class="circle-btn" style="width:40px; height:40px; background:#E1F5FE; color:var(--primary-azure); font-size:1rem;" onclick="event.stopPropagation(); dial('${c.number}')"><i class="fas fa-phone"></i></button>
                    </div>`;
            });
        });

        // السجلات
        const logsRef = db.ref('users/' + currentUser.uid + '/logs');
        logsRef.orderByKey().limitToLast(20).on('value', snapshot => {
             const list = document.getElementById('logs-list');
             list.innerHTML = '';
             const data = snapshot.val();
             if(!data) { list.innerHTML = '<p style="text-align:center; color:#999; padding:30px;">لا توجد سجلات</p>'; return; }
             Object.values(data).reverse().forEach(log => {
                 list.innerHTML += `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:bold;">${log.to || 'مجهول'}</div>
                            <div style="font-size:0.8rem; color:#888;">${new Date(log.date).toLocaleString()} - ${log.duration || '0:00'}</div>
                        </div>
                        ${log.cost ? `<span style="color:${log.type === 'outgoing' ? '#d32f2f' : '#4CAF50'}; font-weight:bold;">${log.type === 'outgoing' ? '-$' : '+$'}${log.cost.toFixed(2)}</span>` : ''}
                    </div>`;
             });
        });

        // الرسائل (مع تعديل لفتح الدردشة)
        const msgsRef = db.ref('users/' + currentUser.uid + '/messages');
        msgsRef.orderByKey().limitToLast(20).on('value', snapshot => {
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            const data = snapshot.val();
            if(!data) { list.innerHTML = '<p style="text-align:center; color:#999; padding:30px;">لا توجد رسائل</p>'; return; }
            Object.values(data).reverse().forEach(msg => {
                // عند الضغط على الرسالة نفتح الشات
                list.innerHTML += `
                    <div class="list-item" onclick="openChatInterface('${msg.number}', '${msg.name || msg.number}')">
                        <div>
                            <div style="font-weight:bold;">${msg.number}</div>
                            <div style="font-size:0.8rem; color:#888; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${msg.text}</div>
                        </div>
                    </div>`;
            });
        });
    }

    // --- إخفاء الرقم ---
    function toggleAlias() {
        const isHidden = document.getElementById('chk-hide-id').checked;
        const container = document.getElementById('alias-input-container');
        if(isHidden) container.classList.add('open');
        else container.classList.remove('open');
    }

    // --- تحويل الرصيد ---
    function processTransfer() {
        const receiverId = document.getElementById('transfer-to').value.trim();
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        
        if(!receiverId || isNaN(amount) || amount <= 0) return showToast("بيانات غير صحيحة");
        if(amount > balance) return showToast("رصيد غير كافٍ");
        
        const senderRef = db.ref('users/' + currentUser.uid + '/balance');
        const receiverRef = db.ref('users/' + receiverId + '/balance');

        senderRef.transaction((currentBalance) => {
            if (currentBalance < amount) return; 
            return currentBalance - amount;
        });

        receiverRef.transaction((currentBalance) => {
            return (currentBalance || 0) + amount;
        });

        const reportRef = db.ref('users/' + currentUser.uid + '/logs');
        reportRef.push({
            to: "تحويل إلى " + receiverId,
            type: "transfer",
            date: Date.now(),
            cost: -amount
        });

        showToast("تم التحويل بنجاح");
        closeSubPage('page-transfer');
    }

    // --- الاتصال الحقيقي ---
    function initTwilioDevice() {
        const url = window.location.origin;
        fetch(`${url}/token?identity=${currentUser.uid}`)
            .then(response => {
                if(!response.ok) throw new Error("Backend not reachable");
                return response.text();
            })
            .then(token => {
                device = new Twilio.Device(token, { codecPreferences: ['opus', 'pcmu'], fakeLocalDTMF: true });
                device.on('ready', () => console.log('Ready!'));
                device.on('connect', (conn) => {
                    document.getElementById('call-status').innerText = "متصل";
                    document.getElementById('call-name-display').innerText = conn.parameters.CustomDisplayName || dialNumber;
                    startCallTimer();
                });
                device.on('disconnect', () => endCallUI());
            })
            .catch(err => console.warn("Backend connection failed:", err));
    }

    function initiateRealCall() {
        if(!dialNumber) return showToast("أدخل رقم");
        
        // إصلاح: إظهار الواجهة فوراً بغض النظر عن الاتصال الفعلي لتجربة التصميم
        document.getElementById('call-screen').style.display = 'flex';
        document.getElementById('call-number-display').innerText = dialNumber;
        document.getElementById('call-name-display').innerText = dialNumber;
        document.getElementById('call-status').innerText = "جاري الاتصال...";
        document.getElementById('call-timer').style.display = 'block';
        
        const alias = document.getElementById('alias-input').value;
        const displayName = alias || dialNumber;
        document.getElementById('call-name-display').innerText = displayName;

        if (device) {
            device.connect({ 
                To: dialNumber, 
                CustomDisplayName: displayName, 
                callerId: '+12365066055' // رقمك من Twilio
            });
            updateBalance(-0.05);
            logCall(dialNumber, 'outgoing', 0.05);
        }
        
        startCallTimer();
    }

    function hangupCall() { 
        if(device) device.disconnectAll();
        endCallUI();
    }
    
    function endCallUI() {
        document.getElementById('call-screen').style.display = 'none';
        document.getElementById('call-timer').style.display = 'none';
        clearInterval(callTimer);
    }

    function sendDtmf(d) { if(device && device.activeConnection()) device.activeConnection().sendDigits(d); }
    function toggleMute(btn) { if(device && device.activeConnection()) { device.activeConnection().mute(!device.activeConnection().isMuted()); btn.classList.toggle('active'); }}
    function toggleSpeaker(btn) { btn.classList.toggle('active'); }
    
    function startCallTimer() {
        callSeconds = 0;
        clearInterval(callTimer);
        callTimer = setInterval(() => {
            callSeconds++;
            let m = Math.floor(callSeconds/60).toString().padStart(2,'0');
            let s = (callSeconds%60).toString().padStart(2,'0');
            document.getElementById('call-timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    // --- وظائف الواجهة والتنقل ---
    function nav(pageId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    function dial(k) { if(dialNumber.length<15){ dialNumber+=k; document.getElementById('dial-number').innerText=dialNumber; }}
    function deleteDigit() { dialNumber = dialNumber.slice(0,-1); document.getElementById('dial-number').innerText = dialNumber; }
    function setDial(n) { dialNumber=n; document.getElementById('dial-number').innerText=n; }

    // --- إدارة الصفحات الفرعية (Sub-Pages) ---
    function openSubPage(id) { document.getElementById(id).style.display = 'flex'; }
    function closeSubPage(id) { document.getElementById(id).style.display = 'none'; }

    // --- الرسائل ---
    function switchMsgTab(type, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        
        if(type === 'notifications') {
            document.getElementById('msg-notifications').style.display = 'block';
            document.getElementById('msg-sms').style.display = 'none';
        } else {
            document.getElementById('msg-notifications').style.display = 'none';
            document.getElementById('msg-sms').style.display = 'block';
        }
    }

    function openChatInterface(number, name) {
        currentChatNumber = number;
        document.getElementById('chat-contact-name').innerText = name || number;
        const msgsContainer = document.getElementById('chat-messages');
        msgsContainer.innerHTML = '';
        // محاكاة تحميل الرسائل من Firebase (تطوير بسيط)
        db.ref('users/' + currentUser.uid + '/messages').orderByByKey().limitToLast(20).once('value', snapshot => {
             const data = snapshot.val();
             if(data) {
                 Object.values(data).filter(m => m.number === number).forEach(m => {
                     msgsContainer.innerHTML += `<div class="message-bubble ${m.type === 'sent' ? 'msg-sent' : 'msg-received'}">${m.text}</div>`;
                 });
             }
        });
        openSubPage('page-chat');
    }

    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value;
        if(!text) return;
        
        const msgsContainer = document.getElementById('chat-messages');
        msgsContainer.innerHTML += `<div class="message-bubble msg-sent">${text}</div>`;
        
        // حفظ في Firebase
        db.ref('users/' + currentUser.uid + '/messages').push({
            number: currentChatNumber,
            text: text,
            type: 'sent',
            timestamp: Date.now()
        });
        
        input.value = '';
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }

    function openNewMessageUI() { openSubPage('modal-new-msg'); }
    function sendNewMessage() {
        const to = document.getElementById('new-msg-to').value;
        const body = document.getElementById('new-msg-body').value;
        if(to && body) {
            db.ref('users/' + currentUser.uid + '/messages').push({number:to, text:body, type:'sent', timestamp:Date.now()});
            closeSubPage('modal-new-msg');
            showToast("تم إرسال الرسالة");
        }
    }

    // --- إدارة الأسماء ---
    function openAddContact() { openSubPage('modal-add-contact'); }
    function saveNewContact() {
        const name = document.getElementById('new-contact-name').value;
        const number = document.getElementById('new-contact-number').value;
        if(name && number) {
            db.ref('users/' + currentUser.uid + '/contacts').push({name, number});
            closeSubPage('modal-add-contact');
            showToast("تم الحفظ");
        }
    }

    // --- تبويبات أخرى ---
    function switchContactTab(type, el) { 
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        // يمكن إضافة منطق التصفية هنا
    }
    
    function switchLogTab(type, el) { 
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active'); 
    }

    // --- الدفع ---
    function selectPrice(amt, el) { 
        activeTransferPrice = amt; 
        document.querySelectorAll('.more-card').forEach(o=>o.classList.remove('active')); 
        el.classList.add('active'); 
        if(window.paypal) {
             paypal.Buttons({
                createOrder: (data, actions) => actions.order.create({ purchase_units: [{ amount: { value: amt } }] }),
                onApprove: (data, actions) => { 
                    updateBalance(activeTransferPrice); 
                    closeSubPage('page-topup'); 
                    showToast("تم الشحن بنجاح"); 
                }
            }).render('#paypal-container');
        } else {
            document.getElementById('demo-pay').style.display = 'block';
        }
    }
    function simulatePay() { updateBalance(activeTransferPrice); showToast("تم الشحن"); }

    function updateBalance(amount) { db.ref('users/' + currentUser.uid + '/balance').set(balance + amount); }
    function logCall(to, type, cost) { db.ref('users/' + currentUser.uid + '/logs').push({to:to, type:type, date:Date.now(), cost:cost}); }

    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

    // --- إعداد الضغط المطول على زر (0) ---
    window.onload = function() {
        const btn0 = document.getElementById('key-0');
        let pressTimer;
        
        const startPress = (e) => {
            if(e.type === 'mousedown' || e.type === 'touchstart') e.preventDefault(); 
            pressTimer = setTimeout(() => {
                dial('+');
                pressTimer = null;
            }, 800);
        };
        
        const endPress = () => {
            if (pressTimer) {
                dial('0');
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        };
        
        btn0.addEventListener('mousedown', startPress);
        btn0.addEventListener('touchstart', startPress);
        btn0.addEventListener('mouseup', endPress);
        btn0.addEventListener('touchend', endPress);
        
        if(window.paypal) document.getElementById('demo-pay').style.display = 'none';
    };
</script>
</body>
</html>
